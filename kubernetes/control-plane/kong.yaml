apiVersion: v1
kind: Service
metadata:
  name: cortexia-kong
  namespace: cortexia
  labels:
    app: cortexia-kong
spec:
  ports:
    - port: 8000
      name: proxy
    - port: 8001
      name: admin
  selector:
    app: cortexia-kong
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cortexia-kong
  namespace: cortexia
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cortexia-kong
  template:
    metadata:
      labels:
        app: cortexia-kong
    spec:
      initContainers:
        - name: wait-for-postgres
          image: busybox
          command: ['sh', '-c', 'until nc -z cortexia-postgres 5432; do echo waiting for postgres; sleep 2; done;']
      containers:
        - name: kong
          image: kong/kong-gateway:3.5
          env:
            - name: KONG_DATABASE
              value: "postgres"
            - name: KONG_PG_HOST
              value: "cortexia-postgres"
            - name: KONG_PG_PORT
              value: "5432"
            - name: KONG_PG_USER
              valueFrom:
                secretKeyRef:
                  name: cortexia-secrets
                  key: postgres-user
            - name: KONG_PG_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: cortexia-secrets
                  key: postgres-password
            - name: KONG_PG_DATABASE
              value: "kong"
            - name: KONG_PROXY_LISTEN
              value: "0.0.0.0:8000"
            - name: KONG_ADMIN_LISTEN
              value: "0.0.0.0:8001"
          ports:
            - containerPort: 8000
              name: proxy
            - containerPort: 8001
              name: admin
---
apiVersion: batch/v1
kind: Job
metadata:
  name: cortexia-kong-migrations
  namespace: cortexia
spec:
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-postgres
          image: busybox
          command: ['sh', '-c', 'until nc -z cortexia-postgres 5432; do echo waiting for postgres; sleep 2; done;']
      containers:
        - name: kong-migrations
          image: kong/kong-gateway:3.5
          command: [ "kong", "migrations", "bootstrap" ]
          env:
            - name: KONG_DATABASE
              value: "postgres"
            - name: KONG_PG_HOST
              value: "cortexia-postgres"
            - name: KONG_PG_PORT
              value: "5432"
            - name: KONG_PG_USER
              valueFrom:
                secretKeyRef:
                  name: cortexia-secrets
                  key: postgres-user
            - name: KONG_PG_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: cortexia-secrets
                  key: postgres-password
            - name: KONG_PG_DATABASE
              value: "kong"
